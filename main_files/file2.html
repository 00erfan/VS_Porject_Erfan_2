<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>Bar Chart with Manipulation</title>
</head>

<body>

    <style>
        .axis .domain {
            display: none;
        }
    </style>
    <select id="selectButton"></select>
    <svg width="960" height="500"></svg>
    <script src="../lib/d3.js"></script>
    <script src="../lib/d3-selection-multi.v1.js"></script>
    <script src="../lib/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script>

        var svg = d3.select("svg"),
            margin = { top: 20, right: 20, bottom: 30, left: 40 },
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        // Create data = list of groups
        var allGroup = ["Cyprus", "Switzerland", "Czech Republic", "Spain", "Poland"];

        // add the options to the button
        d3.select("#selectButton")
            .selectAll('myOptions') // Next 4 lines add 6 options = 6 colors
            .data(allGroup)
            .enter()
            .append('option')
            .text(function (d) { return d; }) // text showed in the menu
            .attr("value", function (d) { return d; }) // corresponding value returned by the button


        var x0 = d3.scaleBand()
            .rangeRound([0, width])
            .paddingInner(0.1);

        var x1 = d3.scaleBand()
            .padding(0.05);

        var y = d3.scaleLinear()
            .rangeRound([height, 0]);

        var z = d3.scaleOrdinal()
            .range(d3.schemeCategory10);

        d3.csv("../INAIL_data/data_aulaweb.csv", function (d, i, columns) {
            for (var i = 1, n = columns.length; i < n; ++i) d[columns[i]] = +d[columns[i]];
            return d;
        }, function (error, data) {
            if (error) throw error;

            console.log(data);

            country = "Bulgaria";

            // First time it draws
            renderBars(data, country);

        });

        function renderBars(data, country) {

            data_filt = data.filter(function (d) { return (d.GEO == country || d.GEO == "Hungary" || d.GEO == "Czech Republic") })

            var keys = data.columns.slice(1);

            //console.log(keys);

            x0.domain(data_filt.map(function (d) { return d.GEO; }));
            x1.domain(keys).rangeRound([0, x0.bandwidth()]);
            y.domain([0, d3.max(data, function (d) { return d3.max(keys, function (key) { return d[key]; }); })]).nice();

            ////////////////////////////////////////////////////

            //selection = svg.selectAll("rect")
            //    .data(data_filt);

            const selection = g.append("g")
                .selectAll("g")
                .data(data_filt);


            exiting = selection
                .selectAll("g")
                .exit()
                .remove();


            console.log("entering");
            entering = selection
                .enter()
                .append("g")
                .attr("transform", function (d) { return "translate(" + x0(d.GEO) + ",0)"; })
                .selectAll("rect")
                .data(function (d) { return keys.map(function (key) { return { key: key, value: d[key] }; }); })
                .enter().append("rect")
                .merge(selection)
                .transition()
                .duration(1000)
                .ease(d3.easeLinear)
                .attr("x", function (d) { return x1(d.key); })
                .attr("y", function (d) { return y(d.value); })
                .attr("width", x1.bandwidth())
                .attr("height", function (d) { return height - y(d.value); })
                .attr("fill", function (d) { return z(d.key); });


            g.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x0));

            g.append("g")
                .attr("class", "axis")
                //.call(d3.axisLeft(y).ticks(null, "s"))
                .call(d3.axisLeft(y))
                .append("text")
                .attr("x", 5)
                .attr("y", y(y.ticks().pop()) + 0.0)
                .attr("dy", "0.35em")
                .attr("fill", "#000")
                .attr("font-weight", "bold")
                .attr("text-anchor", "start")
                .text("Geoeconomics");


            var legend = g.append("g")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
                .attr("text-anchor", "end")
                .selectAll("g")
                .data(keys.slice().reverse())
                .enter().append("g")
                .attr("transform", function (d, i) { return "translate(0," + i * 20 + ")"; });

            legend.append("rect")
                .attr("x", width - 25)
                .attr("width", 25)
                .attr("height", 25)
                .attr("fill", z);

            legend.append("text")
                .attr("x", width - 28)
                .attr("y", 12)
                .attr("dy", "0.32em")
                .text(function (d) { return d; });



            // When the button is changed, run the updateChart function
            d3.select("#selectButton").on("change", function (d) {
                // recover the option that has been chosen
                selectedOption = d3.select(this).property("value")
                // run the updateChart function with this selected option
                console.log(selectedOption);

                renderBars(data, selectedOption);

            })


        }




    </script>

</body>